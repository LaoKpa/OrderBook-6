<!doctype html>
<html lang="en" ng-app = "mainApp">

<head>
    <meta charset="UTF-8">
    <title>Simple Graph</title>
       <!-- why not https://ajax.googleapis.com/ajax/libs/angularjs/1.4.3/angular.min.js?
       google is blocked by great wall
       -->

    <script src = "ajax/libs/angularjs/1.4.3/angular.min.js"></script>

    <link    href="c3/c3.min.0.4.14.css" rel="stylesheet">
    <script type="text/javascript" src="c3/d3.v3.js"></script>
    <script src = "c3/c3.min.0.4.14.js"></script>


      <style>
         table, th , td {
            border: 1px solid grey;
            border-collapse: collapse;
            padding: 5px;
         }
         
         table tr:nth-child(odd) {
            background-color: #f2f2f2;
         }
         
         table tr:nth-child(even) {
            background-color: #ffffff;
         }

          #chart div {
           display: inline-block;
           background: #4285F4;
           width: 20px;
           margin-right: 3px;
           }
      </style>
      
   </head>
   <body>
        <h2>Test Summary</h2>



    <div ng-controller = "order_book_table_USDJPY">

        <table>
            <!--
                ////https://stackoverflow.com/questions/14788652/how-to-filter-key-value-with-ng-repeat-in-angularjs
            -->
            <tr ng-repeat = "(item, value) in filterOutLatencyDataFromMap(test_summary)  ">
                <!--
                https://docs.angularjs.org/api/ng/filter/number
                https://stackoverflow.com/questions/36091421/how-to-add-thousand-separating-commas-for-numbers-in-angularjs
                -->
                <td align="right">{{ item }}</td>
                <td>{{ value }}</td>

            </tr>
        </table>

        <h3>Latency Chart</h3>
        <div id="latency_chart"></div>
        Show Latency Detail Data: <input type="checkbox" checked="true"  ng-model="latencyDataChecked" aria-label="Toggle ngShow"><br />
        <div ng-show="latencyDataChecked">
            <table>

                <tr>
                    <td>recvTime</td>
                    <td>put2InputQ</td>
                    <td>pickFromInputQ</td>
                    <td>match</td>
                    <td>pickFromOutputQ</td>
                </tr>
                <tr ng-repeat = "one_record in test_summary.latency_data ">
                    <!--
                    https://docs.angularjs.org/api/ng/filter/number
                    https://stackoverflow.com/questions/36091421/how-to-add-thousand-separating-commas-for-numbers-in-angularjs
                    -->
                    <td align="right">{{ one_record[0] }}</td>
                    <td align="right">{{ one_record[1] | number : 0}}</td>
                    <td align="right">{{ one_record[2] | number : 0}}</td>
                    <td align="right">{{ one_record[3] | number : 0}}</td>
                    <td align="right">{{ one_record[4] | number : 0}}</td>

                </tr>
            </table>
        </div>


        <h3>GC Took Chart</h3>
        <div id="gc_took_chart"></div>
        Show GC took time Detail Data: <input type="checkbox" checked="true"  ng-model="gcTookTimeChecked" aria-label="Toggle ngShow"><br />
        <div ng-show="gcTookTimeChecked">
            <table>

                <tr>
                    <td>time</td>
                    <td>tookInMacroSeconds</td>
                    <td>type</td>
                </tr>
                <tr ng-repeat = "one_record in test_summary.gc_took ">
                    <!--
                    https://docs.angularjs.org/api/ng/filter/number - this link tells how to format the number in js and html.GOOD.
                    https://stackoverflow.com/questions/36091421/how-to-add-thousand-separating-commas-for-numbers-in-angularjs
                    -->
                    <td align="right">{{ one_record[0] }}</td>
                    <td align="right">{{ one_record[1] | number : 0}}</td>
                    <td align="right">{{ one_record[2] }}</td>

                </tr>
            </table>
        </div>
    </div>


    <p id="console_container"></p>

        <script>

            //http://c3js.org/samples/data_stringx.html
            var latency_chart = c3.generate({
                bindto: '#latency_chart',
                data: {
                    x : 'x',
                    columns:  [
                        ['x','x1','x2','x3'],
                        ['data1',1,2,3]
                    ]
                },
                axis: {
                    x: {
                        type: 'category' // this needed to load string x value
                    }
                }
            });
            latency_chart.unload({
				ids: ['data1']
			});

            var gc_took_chart = c3.generate({
                bindto: '#gc_took_chart',
                data: {
                    x : 'x',
                    columns:  [
                        ['x','x1','x2','x3'],
                        ['data1',1,2,3]
                    ]
                },
                axis: {
                    x: {
                        type: 'category' // this needed to load string x value
                    }
                }
            });
            gc_took_chart.unload({
				ids: ['data1']
			});

            var mainApp = angular.module("mainApp", []);

            mainApp.controller('order_book_table_USDJPY', function($scope, $http) {
                $http.get('/matching/get_test_summary').
                    then(function(response) {
                        $scope.test_summary = response.data;

                        var latency_data_copy = new Array(response.data['latency_data'].length);
                        for(var i = 0; i < response.data['latency_data'].length; i++){	latency_data_copy[i] = response.data['latency_data'][i].slice(0);}
                        var columnLatencyData = latency_data_copy[0].map((col, i) => latency_data_copy.map(row => row[i]));
                        columnLatencyData[0].unshift('x'); //categary - recvTime
                        columnLatencyData[1].unshift('put2InputQ_ns');
                        columnLatencyData[2].unshift('pickFromInputQ_ns');
                        columnLatencyData[3].unshift('match_ns');
                        columnLatencyData[4].unshift('pickFromOutputQ_ns');
                        //addParagraph('console_container',latency_data_copy.length);
                        //addParagraph('console_container',latency_data_copy[0].length);
                        latency_chart.load({
                            columns: [
                                columnLatencyData[0],
                                columnLatencyData[1],
                                columnLatencyData[2],
                                columnLatencyData[3],
                                columnLatencyData[4]
                            ]
                        });


                        var gc_data_copy = new Array(response.data['gc_took'].length);
                        for(var i = 0; i < response.data['gc_took'].length; i++){	gc_data_copy[i] = response.data['gc_took'][i].slice(0);}
                        var columnGCTookData = gc_data_copy[0].map((col, i) => gc_data_copy.map(row => row[i]));
                        columnGCTookData[0].unshift('x'); //categary - recvTime
                        columnGCTookData[1].unshift('took_us');
                        columnGCTookData[2].unshift('type');
                        gc_took_chart.load({
                            columns: [
                                columnGCTookData[0],
                                columnGCTookData[1],
                                columnGCTookData[2],
                            ]
                        });

                    });

                //https://stackoverflow.com/questions/14788652/how-to-filter-key-value-with-ng-repeat-in-angularjs
                //it is not easy to filter map(but easy to filter a plain value - http://docs.angularjs.org/api/ng.filter:filter)
                $scope.filterOutLatencyDataFromMap = function(items) {
                    var result = {};
                    angular.forEach(items, function(value, key) {
                        if (key !== 'latency_data' && key !== 'gc_took' ) {
                            result[key] = value;
                        }
                    });
                    return result;
                }

            });

    function addParagraph(containerName, text){

	 	var container = document.getElementById(containerName);
	 	var p = document.createElement('p');
	 	p.innerHTML = text;
	 	container.appendChild(p);

    }
        </script>
      
    </body>
</html>